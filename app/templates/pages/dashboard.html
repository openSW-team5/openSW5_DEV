{% set navbar_variant = 'default' %} {% set footer_active = 'home' %} {% extends
"base.html" %} {% block content %}

<script src="/static/js/category-sync.js"></script>

<div
  class="px-[35px]"
  style="padding-top: 107px; padding-bottom: 107px"
  x-data="{
    categories: [],
    isLoggedIn: {{ 'true' if user_id else 'false' }},
    init() {
      if (this.isLoggedIn) {
        this.categories = window.CategorySync.getCategories();
        // storage 변경 감지 (다른 탭에서 변경시 동기화)
        window.CategorySync.onStorageChange((updatedCategories) => {
          this.categories = updatedCategories;
        });
      } else {
        // 로그인 안 했을 때 템플릿 카드 1개만 표시
        this.categories = [{
          name: '식비',
          icon: 'food.svg',
          budget: 300000,
          spent: 0
        }];
      }
    },
    formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
  }"
>
  <!-- Total Spent & Monthly Budget Card -->
  <div
    class="relative w-[358px] h-[110px] bg-white rounded-[20px] shadow-[0px_8px_33px_-9px_rgba(0,0,0,0.15)] mb-[25px]"
  >
    <!-- Circular Progress Chart -->
    <div
      class="absolute"
      style="left: 33px; top: 13px; width: 84px; height: 84px"
    >
      <canvas id="totalSpentChart"></canvas>
    </div>

    <!-- Total spent label -->
    <div
      class="absolute flex items-center font-montserrat font-normal text-[15px] leading-[18px] text-black"
      style="left: 150px; top: 7px; width: 83px; height: 18px"
    >
      Total spent
    </div>

    <!-- Total spent amount - 250,000원 -->
    <div
      class="absolute flex items-center font-montserrat font-semibold text-[20px] leading-[24px] text-black"
      style="left: 150px; top: 28px; width: 100px; height: 24px"
    >
      {% if user_id %}250,000원{% else %}0원{% endif %}
    </div>

    <!-- Monthly budget label -->
    <div
      class="absolute flex items-center font-montserrat font-normal text-[15px] leading-[18px] text-black"
      style="left: 150px; top: 59px; width: 123px; height: 18px"
    >
      Monthly budget
    </div>

    <!-- Monthly budget amount - 1,000,000원 -->
    <div
      class="absolute flex items-center font-montserrat font-semibold text-[20px] leading-[24px] text-black"
      style="left: 150px; top: 80px; width: 116px; height: 24px"
    >
      {% if user_id %}1,000,000원{% else %}0원{% endif %}
    </div>
  </div>

  <!-- Spendings Title -->
  <div class="flex justify-center items-center mb-[13px]" style="margin-top: 25px">
    <h2 class="font-montserrat font-bold text-[25px] leading-[30px] text-black">
      Spendings
    </h2>
  </div>

  <!-- Month Navigation -->
  <div class="mb-[18px]">
    <div class="flex items-center justify-between">
      <button
        id="prevMonthBtn"
        class="w-[35px] h-[35px] flex items-center justify-center"
      >
        <svg
          width="14"
          height="14"
          viewBox="0 0 14 14"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          style="transform: rotate(90deg)"
        >
          <path
            d="M11.4899 4.10156H2.51017C2.24083 4.10156 2.09044 4.38594 2.25724 4.58008L6.74708 9.78633C6.8756 9.93535 7.12306 9.93535 7.25294 9.78633L11.7428 4.58008C11.9096 4.38594 11.7592 4.10156 11.4899 4.10156Z"
            fill="black"
          />
        </svg>
      </button>
      <div class="flex items-center gap-[8px]">
        <h3
          id="currentMonth"
          class="font-montserrat font-medium text-[20px] text-black"
        >
          October
        </h3>
      </div>
      <button
        id="nextMonthBtn"
        class="w-[35px] h-[35px] flex items-center justify-center"
      >
        <svg
          width="14"
          height="14"
          viewBox="0 0 14 14"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          style="transform: rotate(-90deg)"
        >
          <path
            d="M11.4899 4.10156H2.51017C2.24083 4.10156 2.09044 4.38594 2.25724 4.58008L6.74708 9.78633C6.8756 9.93535 7.12306 9.93535 7.25294 9.78633L11.7428 4.58008C11.9096 4.38594 11.7592 4.10156 11.4899 4.10156Z"
            fill="black"
          />
        </svg>
      </button>
    </div>
  </div>

  <!-- Category Cards (Dynamic) -->
  <template x-for="(category, index) in categories" :key="index">
    <div
      class="flex justify-center"
      style="margin-bottom: 15px"
      x-init="$nextTick(() => {
           const ctx = document.getElementById('categoryChart' + index);
           const percentage = ((category.spent / category.budget) * 100).toFixed(2);
           const remaining = category.budget - category.spent;

           new Chart(ctx, {
             type: 'doughnut',
             data: {
               datasets: [{
                 data: [category.spent, remaining > 0 ? remaining : 0],
                 backgroundColor: ['#63A1FF', '#E5E5E5'],
                 borderWidth: 0,
                 cutout: '78%',
                 borderRadius: 8
               }]
             },
             options: {
               responsive: true,
               maintainAspectRatio: true,
               plugins: {
                 legend: { display: false },
                 tooltip: { enabled: false }
               }
             },
             plugins: [{
               id: 'centerText',
               beforeDraw: function(chart) {
                 const width = chart.width;
                 const height = chart.height;
                 const ctx = chart.ctx;
                 ctx.restore();
                 const fontSize = 11;
                 ctx.font = `600 ${fontSize}px Montserrat`;
                 ctx.fillStyle = '#000000';
                 ctx.textBaseline = 'middle';
                 const text = percentage + '%';
                 const textX = Math.round((width - ctx.measureText(text).width) / 2);
                 const textY = height / 2;
                 ctx.fillText(text, textX, textY);
                 ctx.save();
               }
             }]
           });
         })"
    >
      <div class="relative w-[358px] h-[86px]">
        <!-- Card Background -->
        <div
          class="absolute inset-0 bg-white shadow-[0px_8px_33px_-9px_rgba(0,0,0,0.15)] rounded-[20px]"
        ></div>

        <!-- Progress circle -->
        <div
          class="absolute"
          style="left: 4.75%; top: 12.79%; width: 17.88%; height: 74.42%"
        >
          <canvas :id="'categoryChart' + index"></canvas>
        </div>

        <!-- Category Icon -->
        <div
          class="absolute bg-[#F2F2F2] rounded-lg flex items-center justify-center"
          style="left: 24.3%; top: 19.77%; width: 15.64%; height: 60.47%"
        >
          <img
            :src="'/static/assets/' + category.icon"
            :alt="category.name"
            class="w-[70%] h-[70%] object-contain"
          />
        </div>

        <!-- Category Name -->
        <div
          class="absolute font-yidstreet font-bold text-[15px] leading-[20px]"
          style="left: 43.3%; right: 19.83%; top: 12%; color: #1b1b1b"
          x-text="category.name"
        ></div>

        <!-- Amount Labels and Values -->
        <div
          class="absolute flex flex-col justify-center"
          style="left: 43.3%; top: 42%; right: 5%; bottom: 12%"
        >
          <div
            class="flex justify-between items-baseline font-yidstreet"
            style="margin-bottom: 3px"
          >
            <span class="font-bold text-[14px]" style="color: #878787"
              >사용금액</span
            >
            <span
              class="font-bold text-[12px]"
              style="color: #1b1b1b"
              x-text="formatNumber(category.spent) + '원'"
            ></span>
          </div>
          <div class="flex justify-between items-baseline font-yidstreet">
            <span class="font-bold text-[14px]" style="color: #878787"
              >예산</span
            >
            <span
              class="font-bold text-[12px]"
              style="color: #1b1b1b"
              x-text="formatNumber(category.budget) + '원'"
            ></span>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    // Month navigation with Day.js
    dayjs.locale('ko');
    let currentDate = dayjs();
    const currentMonthText = document.getElementById("currentMonth");
    const prevMonthBtn = document.getElementById("prevMonthBtn");
    const nextMonthBtn = document.getElementById("nextMonthBtn");

    function updateMonthDisplay() {
      // 한글 월 이름 표시 (예: "12월")
      currentMonthText.textContent = currentDate.format('M월');

      // 해당 월의 시작/끝 날짜 계산
      const startOfMonth = currentDate.startOf('month').format('YYYY-MM-DD');
      const endOfMonth = currentDate.endOf('month').format('YYYY-MM-DD');

      console.log("조회 기간:", startOfMonth, "~", endOfMonth);
      console.log("선택된 월:", currentDate.format('YYYY년 M월'));
    }

    prevMonthBtn.addEventListener("click", function () {
      currentDate = currentDate.subtract(1, 'month');
      updateMonthDisplay();
    });

    nextMonthBtn.addEventListener("click", function () {
      currentDate = currentDate.add(1, 'month');
      updateMonthDisplay();
    });

    // Initialize month display
    updateMonthDisplay();

    // Total Spent Chart
    const ctx = document.getElementById('totalSpentChart');
    const isLoggedIn = {{ 'true' if user_id else 'false' }};
    const totalBudget = isLoggedIn ? 1000000 : 0;
    const totalSpent = isLoggedIn ? 250000 : 0;
    const remaining = totalBudget - totalSpent;
    const percentage = totalBudget > 0 ? ((totalSpent / totalBudget) * 100).toFixed(2) : '0.00';

    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['사용', '남음'],
        datasets: [{
          data: totalBudget > 0 ? [totalSpent, remaining] : [1],
          backgroundColor: totalBudget > 0 ? ['#63A1FF', '#E5E5E5'] : ['#E5E5E5'],
          borderWidth: 0,
          cutout: '82%',
          borderRadius: 10
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: false
          }
        }
      },
      plugins: [{
        id: 'centerText',
        beforeDraw: function(chart) {
          const width = chart.width;
          const height = chart.height;
          const ctx = chart.ctx;
          ctx.restore();
          const fontSize = 15;
          ctx.font = `600 ${fontSize}px Montserrat`;
          ctx.fillStyle = '#000000';
          ctx.textBaseline = 'middle';
          const text = percentage + '%';
          const textX = Math.round((width - ctx.measureText(text).width) / 2);
          const textY = height / 2;
          ctx.fillText(text, textX, textY);
          ctx.save();
        }
      }]
    });
  </script>
  {% endblock %}
</div>
