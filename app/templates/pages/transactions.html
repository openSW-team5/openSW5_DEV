{% set navbar_variant = 'default' %}
{% set footer_active = 'chart' %}
{% extends "base.html" %}

{% block content %}
<div class="px-5" style="padding-top: 107px; padding-bottom: 107px;">
    <!-- Header with Year Selector -->
    <div class="flex items-center justify-center mb-6 relative">
      <!-- Year selector: left 55px -->
      <div class="absolute left-[35px] flex items-center gap-[3px]">
        <select id="yearSelect" class="font-montserrat font-semibold text-[15px] text-text bg-transparent border-none outline-none appearance-none cursor-pointer">
          <option>2025</option>
          <option>2024</option>
          <option>2023</option>
        </select>
        <svg id="yearArrow" class="cursor-pointer" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M11.4899 4.10156H2.51017C2.24083 4.10156 2.09044 4.38594 2.25724 4.58008L6.74708 9.78633C6.8756 9.93535 7.12306 9.93535 7.25294 9.78633L11.7428 4.58008C11.9096 4.38594 11.7592 4.10156 11.4899 4.10156Z" fill="black"/>
        </svg>
      </div>
      <h1 class="font-montserrat font-bold text-[25px] text-text">통계</h1>
    </div>

  <!-- Chart Card -->
  <div class="bg-white rounded-[20px] shadow-[0px_8px_33px_-9px_rgba(0,0,0,0.15)] p-6 mb-8">
    <div class="relative" style="height: 220px;">
      <canvas id="transactionsChart"></canvas>
    </div>
  </div>

  <!-- History Header with View Toggle -->
  <div class="relative mb-5 h-[35px]">
    <!-- Search Icon: left: 44px - 20px(padding) = 24px -->
    <a href="/search" class="absolute left-[24px] top-0 w-[35px] h-[35px] flex items-center justify-center cursor-pointer">
      <svg width="35" height="35" viewBox="0 0 35 35" fill="none">
        <g clip-path="url(#clip0_207_1318)">
          <path d="M15.3125 26.25C21.3531 26.25 26.25 21.3531 26.25 15.3125C26.25 9.27189 21.3531 4.375 15.3125 4.375C9.27189 4.375 4.375 9.27189 4.375 15.3125C4.375 21.3531 9.27189 26.25 15.3125 26.25Z" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M23.0467 23.0466L30.625 30.625" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        <defs>
          <clipPath id="clip0_207_1318">
            <rect width="35" height="35" fill="white"/>
          </clipPath>
        </defs>
      </svg>
    </a>

    <!-- History Title: left: 167px - 20px(padding) = 147px -->
    <h2 class="absolute left-[147px] top-[2.5px] w-[94px] h-[30px] font-montserrat font-bold text-[25px] leading-[30px] text-text flex items-center justify-center">History</h2>

    <!-- Month/List Toggle: left: 321px - 20px(padding) = 301px -->
    <div class="absolute left-[301px] top-[3px] w-[71px] h-[29px] flex relative">
      <svg width="71" height="29" viewBox="0 0 71 29" fill="none" xmlns="http://www.w3.org/2000/svg" class="absolute inset-0">
        <rect width="71" height="29" rx="10" fill="#F0F0F0"/>
      </svg>
      <button id="calendarViewBtn" class="relative w-[30px] h-[25px] m-[2px] rounded-[10px] flex items-center justify-center z-0 transition-colors">
        <svg width="23" height="23" viewBox="0 0 23 23" fill="none">
          <g clip-path="url(#clip_calendar)">
            <path opacity="0.2" d="M3.59375 7.90625H19.4062V4.3125C19.4062 4.12188 19.3305 3.93906 19.1957 3.80427C19.0609 3.66948 18.8781 3.59375 18.6875 3.59375H4.3125C4.12188 3.59375 3.93906 3.66948 3.80427 3.80427C3.66948 3.93906 3.59375 4.12188 3.59375 4.3125V7.90625Z" fill="black"/>
            <path d="M18.6875 3.59375H4.3125C3.91555 3.59375 3.59375 3.91555 3.59375 4.3125V18.6875C3.59375 19.0845 3.91555 19.4062 4.3125 19.4062H18.6875C19.0845 19.4062 19.4062 19.0845 19.4062 18.6875V4.3125C19.4062 3.91555 19.0845 3.59375 18.6875 3.59375Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M15.8125 2.15625V5.03125" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7.1875 2.15625V5.03125" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M3.59375 7.90625H19.4062" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M11.5 12.9375C12.0954 12.9375 12.5781 12.4548 12.5781 11.8594C12.5781 11.2639 12.0954 10.7812 11.5 10.7812C10.9046 10.7812 10.4219 11.2639 10.4219 11.8594C10.4219 12.4548 10.9046 12.9375 11.5 12.9375Z" fill="black"/>
            <path d="M15.4531 12.9375C16.0486 12.9375 16.5312 12.4548 16.5312 11.8594C16.5312 11.2639 16.0486 10.7812 15.4531 10.7812C14.8577 10.7812 14.375 11.2639 14.375 11.8594C14.375 12.4548 14.8577 12.9375 15.4531 12.9375Z" fill="black"/>
            <path d="M7.54688 16.5312C8.14231 16.5312 8.625 16.0486 8.625 15.4531C8.625 14.8577 8.14231 14.375 7.54688 14.375C6.95144 14.375 6.46875 14.8577 6.46875 15.4531C6.46875 16.0486 6.95144 16.5312 7.54688 16.5312Z" fill="black"/>
            <path d="M11.5 16.5312C12.0954 16.5312 12.5781 16.0486 12.5781 15.4531C12.5781 14.8577 12.0954 14.375 11.5 14.375C10.9046 14.375 10.4219 14.8577 10.4219 15.4531C10.4219 16.0486 10.9046 16.5312 11.5 16.5312Z" fill="black"/>
            <path d="M15.4531 16.5312C16.0486 16.5312 16.5312 16.0486 16.5312 15.4531C16.5312 14.8577 16.0486 14.375 15.4531 14.375C14.8577 14.375 14.375 14.8577 14.375 15.4531C14.375 16.0486 14.8577 16.5312 15.4531 16.5312Z" fill="black"/>
          </g>
          <defs>
            <clipPath id="clip_calendar">
              <rect width="23" height="23" fill="white"/>
            </clipPath>
          </defs>
        </svg>
      </button>
      <button id="listViewBtn" class="relative w-[30px] h-[25px] m-[2px] rounded-[10px] bg-black bg-opacity-[0.39] flex items-center justify-center z-0 transition-colors">
        <svg width="23" height="23" viewBox="0 0 23 23" fill="none">
          <g clip-path="url(#clip_list)">
            <path opacity="0.2" d="M19.4062 5.75H7.90625V17.25H19.4062V5.75Z" fill="white"/>
            <path d="M7.90625 5.75H19.4062" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7.90714 11.5H19.4062" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7.90714 17.25H19.4062" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M3.95312 6.82812C4.54856 6.82812 5.03125 6.34543 5.03125 5.75C5.03125 5.15457 4.54856 4.67188 3.95312 4.67188C3.35769 4.67188 2.875 5.15457 2.875 5.75C2.875 6.34543 3.35769 6.82812 3.95312 6.82812Z" fill="white"/>
            <path d="M3.95312 12.5781C4.54856 12.5781 5.03125 12.0954 5.03125 11.5C5.03125 10.9046 4.54856 10.4219 3.95312 10.4219C3.35769 10.4219 2.875 10.9046 2.875 11.5C2.875 12.0954 3.35769 12.5781 3.95312 12.5781Z" fill="white"/>
            <path d="M3.95312 18.3281C4.54856 18.3281 5.03125 17.8454 5.03125 17.25C5.03125 16.6546 4.54856 16.1719 3.95312 16.1719C3.35769 16.1719 2.875 16.6546 2.875 17.25C2.875 17.8454 3.35769 18.3281 3.95312 18.3281Z" fill="white"/>
          </g>
          <defs>
            <clipPath id="clip_list">
              <rect width="23" height="23" fill="white"/>
            </clipPath>
          </defs>
        </svg>
      </button>
    </div>
  </div>

  <!-- Month Navigation (for calendar view) -->
  <div id="month-navigation" class="hidden mb-5">
    <div class="flex items-center justify-between">
      <button id="prevMonthBtn" class="w-[35px] h-[35px] flex items-center justify-center">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(90deg);">
          <path d="M11.4899 4.10156H2.51017C2.24083 4.10156 2.09044 4.38594 2.25724 4.58008L6.74708 9.78633C6.8756 9.93535 7.12306 9.93535 7.25294 9.78633L11.7428 4.58008C11.9096 4.38594 11.7592 4.10156 11.4899 4.10156Z" fill="black"/>
        </svg>
      </button>
      <div class="flex items-center gap-[8px]">
        <h3 id="currentMonth" class="font-montserrat font-medium text-[20px] text-text">October</h3>
      </div>
      <button id="nextMonthBtn" class="w-[35px] h-[35px] flex items-center justify-center">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg" style="transform: rotate(-90deg);">
          <path d="M11.4899 4.10156H2.51017C2.24083 4.10156 2.09044 4.38594 2.25724 4.58008L6.74708 9.78633C6.8756 9.93535 7.12306 9.93535 7.25294 9.78633L11.7428 4.58008C11.9096 4.38594 11.7592 4.10156 11.4899 4.10156Z" fill="black"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Calendar View -->
  <div id="calendar-container" class="hidden px-[20px]" style="max-width: 100%; overflow-x: hidden;">
    <!-- Calendar grid will be dynamically loaded here -->
  </div>

  <!-- List View -->
  <div id="transactions-container">
    <!-- Transaction sections will be dynamically loaded here -->
  </div>
  </div>
</div>

<!-- 영수증 상세 모달 -->
<div id="receiptModal" class="fixed inset-0 z-50 hidden" style="background: rgba(0, 0, 0, 0.7); display: none; align-items: flex-start; justify-content: center; padding-top: 80px;" onclick="closeReceiptModal(event)">
  <div class="relative" style="width: 400px; height: 600px;" onclick="event.stopPropagation()">
    <!-- 영수증 SVG 배경 -->
    <svg class="absolute inset-0 pointer-events-none" width="100%" height="100%" viewBox="0 0 354 535" fill="none" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <filter id="filter0_d_209_1553" x="0" y="0" width="354" height="535" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
          <feFlood flood-opacity="0" result="BackgroundImageFix"/>
          <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
          <feOffset dy="4"/>
          <feGaussianBlur stdDeviation="5"/>
          <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.35 0"/>
          <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_209_1553"/>
          <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_209_1553" result="shape"/>
        </filter>
      </defs>
      <g filter="url(#filter0_d_209_1553)">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M10 6H344V515.001L334.722 521L325.444 515.001L316.167 521L306.889 515.001L297.611 521L288.333 515.001L279.056 521L269.778 515.001L260.5 521L251.222 515.001L241.944 521L232.667 515.001L223.389 521L214.111 515.001L204.833 521L195.556 515.001L186.278 521L177 515.001L167.722 521L158.444 515.001L149.167 521L139.889 515.001L130.611 521L121.333 515.001L112.056 521L102.778 515.001L93.5 521L84.2222 515.001L74.9444 521L65.6667 515.001L56.3889 521L47.1111 515.001L37.8333 521L28.5556 515.001L19.2778 521L10 515.001V6Z" fill="#F0F0F0"/>
      </g>
    </svg>

    <!-- 모달 내용 -->
    <div class="relative overflow-y-auto h-full" style="padding: 70px 30px 30px 30px;">
      <!-- 상호명 -->
      <h2 id="modalMerchant" class="font-yidstreet font-bold text-[40px] leading-[52px] text-center text-black" style="margin-bottom: 8px;"></h2>

      <!-- 주소 -->
      <p id="modalAddress" class="font-noto text-[16px] leading-[19px] text-center text-[#878787]" style="margin-bottom: 24px;"></p>

      <!-- 날짜 -->
      <p id="modalDate" class="font-montserrat text-[15px] leading-[18px] text-center text-black" style="margin-bottom: 16px;"></p>

      <div class="border-t border-dashed border-[#979797]" style="margin-bottom: 16px;"></div>

      <!-- 결제 타입 -->
      <div class="flex justify-between items-center" style="margin-bottom: 32px;">
        <span class="font-noto text-[16px] leading-[19px] text-[#878787]">Token Type</span>
        <div class="flex gap-2">
          <button onclick="selectType('expense')" id="typeExpense" class="type-btn w-[45px] h-[30px] border-2 rounded-[20px] font-noto text-[15px] transition-all">
            지출
          </button>
          <button onclick="selectType('income')" id="typeIncome" class="type-btn w-[45px] h-[30px] border-2 rounded-[20px] font-noto text-[15px] transition-all">
            수입
          </button>
          <button onclick="selectType('transfer')" id="typeTransfer" class="type-btn w-[45px] h-[30px] border-2 rounded-[20px] font-noto text-[15px] transition-all">
            이체
          </button>
        </div>
      </div>

      <div class="border-t border-dashed border-[#979797]" style="margin-bottom: 16px;"></div>

      <!-- 카테고리 (지출일 때만 표시) -->
      <div id="categorySection" style="margin-bottom: 24px; position: relative; height: 19px;">
        <span class="font-noto text-[16px] leading-[19px] text-[#878787]" style="position: absolute; left: 0;">카테고리</span>
        <select id="categorySelect" class="border-0 bg-transparent font-noto text-[15px] text-black focus:outline-none" style="padding: 0; position: absolute; right: 0;">
          <option value="">선택하세요</option>
          <option value="식비">식비</option>
          <option value="교통비">교통비</option>
          <option value="카페/간식">카페/간식</option>
          <option value="쇼핑">쇼핑</option>
          <option value="문화/여가">문화/여가</option>
          <option value="의료/건강">의료/건강</option>
          <option value="생활용품">생활용품</option>
          <option value="기타">기타</option>
        </select>
      </div>

      <!-- 상품 헤더 (지출일 때만 표시) -->
      <div id="itemsHeader" class="flex justify-between text-[14px] font-satoshi font-bold text-[#878787]" style="margin-bottom: 8px;">
        <span class="flex-1">상품명</span>
        <span class="w-[26px] text-center">수량</span>
        <span class="w-[60px] text-right">단가</span>
        <span class="w-[60px] text-right">소계</span>
      </div>

      <!-- 상품 목록 (지출일 때만 표시) -->
      <div id="modalItems" style="margin-bottom: 16px;"></div>

      <div id="itemsDivider" class="border-t border-dashed border-[#979797]" style="margin-bottom: 16px;"></div>

      <!-- 합계/금액 -->
      <div class="flex justify-between font-satoshi font-bold text-[16px] text-black" style="margin-bottom: 32px;">
        <span id="totalLabel">합계</span>
        <span id="modalTotal"></span>
      </div>

      <!-- 버튼들 -->
      <div class="flex justify-between items-center">
        <button
          onclick="closeReceiptModal()"
          class="border border-[#878787] rounded-full bg-transparent font-satoshi font-medium text-[16px] text-[#111111] hover:bg-gray-100 transition-colors"
          style="width: 125px; height: 38px;"
        >
          취소
        </button>
        <button
          onclick="editReceipt()"
          class="border border-[#878787] rounded-full bg-transparent font-satoshi font-medium text-[16px] text-[#111111] hover:bg-gray-100 transition-colors"
          style="width: 125px; height: 38px;"
        >
          편집
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// 전역 변수
let receiptsData = [];

document.addEventListener('DOMContentLoaded', async function() {
  // Initialize Transactions Chart
  const ctx = document.getElementById('transactionsChart');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May'],
      datasets: [{
        label: '지출',
        data: [10000, 15000, 20000, 25000, 30000],
        borderColor: '#B4DE00',
        backgroundColor: (context) => {
          const ctx = context.chart.ctx;
          const gradient = ctx.createLinearGradient(0, 0, 0, 220);
          gradient.addColorStop(0, 'rgba(180, 222, 0, 0.47)');
          gradient.addColorStop(1, 'rgba(196, 196, 196, 0)');
          return gradient;
        },
        fill: true,
        tension: 0.4,
        borderWidth: 3,
        pointRadius: 0,
        pointHoverRadius: 6,
        pointHoverBackgroundColor: 'white',
        pointHoverBorderColor: '#B4DE00',
        pointHoverBorderWidth: 3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        intersect: false,
        mode: 'index'
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          enabled: true,
          backgroundColor: 'white',
          titleColor: '#1B1B1B',
          bodyColor: '#1B1B1B',
          borderColor: '#E5E5E5',
          borderWidth: 1,
          padding: 10,
          displayColors: false,
          callbacks: {
            label: function(context) {
              return '￦ ' + context.parsed.y.toLocaleString();
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          grid: {
            color: '#F4F4F4',
            borderDash: [5, 5]
          },
          ticks: {
            font: {
              family: 'Montserrat',
              size: 10,
              weight: 600
            },
            color: '#ABABAB',
            callback: function(value) {
              return '￦' + (value / 1000) + 'K';
            }
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              family: 'Montserrat',
              size: 10,
              weight: 600
            },
            color: '#ABABAB'
          }
        }
      }
    }
  });

  // Year selector arrow click handler
  const yearArrow = document.getElementById('yearArrow');
  const yearSelect = document.getElementById('yearSelect');
  if (yearArrow && yearSelect) {
    yearArrow.addEventListener('click', function() {
      yearSelect.focus();
      yearSelect.click();
    });

    // Year change handler - update calendar when year changes
    yearSelect.addEventListener('change', function() {
      const selectedYear = parseInt(yearSelect.value);
      currentDate.setFullYear(selectedYear);

      // Update calendar if in calendar view
      if (currentView === 'calendar') {
        updateCalendarView();
      }
    });
  }

  // View mode state
  let currentView = 'list'; // 'list' or 'calendar'
  let currentDate = new Date(); // Date 객체 유지 (기존 코드 호환)

  const transactionsContainer = document.getElementById('transactions-container');
  const calendarContainer = document.getElementById('calendar-container');
  const monthNavigation = document.getElementById('month-navigation');
  const calendarViewBtn = document.getElementById('calendarViewBtn');
  const listViewBtn = document.getElementById('listViewBtn');
  const prevMonthBtn = document.getElementById('prevMonthBtn');
  const nextMonthBtn = document.getElementById('nextMonthBtn');
  const currentMonthText = document.getElementById('currentMonth');

  // View toggle handlers
  calendarViewBtn.addEventListener('click', function() {
    switchView('calendar');
  });

  listViewBtn.addEventListener('click', function() {
    switchView('list');
  });

  // Month navigation handlers
  prevMonthBtn.addEventListener('click', function() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    updateCalendarView();
  });

  nextMonthBtn.addEventListener('click', function() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    updateCalendarView();
  });

  function switchView(view) {
    currentView = view;

    if (view === 'calendar') {
      // Update button styles
      calendarViewBtn.classList.add('bg-black', 'bg-opacity-[0.39]');
      calendarViewBtn.querySelectorAll('path').forEach(path => {
        if (path.hasAttribute('stroke')) path.setAttribute('stroke', 'white');
        if (path.hasAttribute('fill')) path.setAttribute('fill', 'white');
      });
      listViewBtn.classList.remove('bg-black', 'bg-opacity-[0.39]');
      listViewBtn.querySelectorAll('path').forEach(path => {
        if (path.hasAttribute('stroke')) path.setAttribute('stroke', 'black');
        if (path.hasAttribute('fill')) path.setAttribute('fill', 'black');
      });

      // Show/hide containers
      transactionsContainer.classList.add('hidden');
      calendarContainer.classList.remove('hidden');
      monthNavigation.classList.remove('hidden');

      updateCalendarView();
    } else {
      // Update button styles
      listViewBtn.classList.add('bg-black', 'bg-opacity-[0.39]');
      listViewBtn.querySelectorAll('path').forEach(path => {
        if (path.hasAttribute('stroke')) path.setAttribute('stroke', 'white');
        if (path.hasAttribute('fill')) path.setAttribute('fill', 'white');
      });
      calendarViewBtn.classList.remove('bg-black', 'bg-opacity-[0.39]');
      calendarViewBtn.querySelectorAll('path').forEach(path => {
        if (path.hasAttribute('stroke')) path.setAttribute('stroke', 'black');
        if (path.hasAttribute('fill')) path.setAttribute('fill', 'black');
      });

      // Show/hide containers
      calendarContainer.classList.add('hidden');
      transactionsContainer.classList.remove('hidden');
      monthNavigation.classList.add('hidden');

      const groupedReceipts = groupReceiptsByDate(receiptsData);
      renderGroupedTransactions(groupedReceipts);
    }
  }

  function updateCalendarView() {
    // Update month text (Day.js로 한글 월 표시)
    dayjs.locale('ko');
    currentMonthText.textContent = dayjs(currentDate).format('M월');

    // Render calendar grid
    renderCalendarGrid();
  }

  function renderCalendarGrid() {
    // Day.js로 계산
    const currentMonth = dayjs(currentDate);
    const year = currentMonth.year();
    const month = currentMonth.month();
    const daysInMonth = currentMonth.daysInMonth();
    const startingDayOfWeek = currentMonth.startOf('month').day(); // 0 = Sunday

    // Group receipts by date for this month
    const receiptsThisMonth = receiptsData.filter(receipt => {
      const receiptDate = dayjs(receipt.purchased_at);
      return receiptDate.year() === year && receiptDate.month() === month;
    });

    // Create a map of date -> total amount
    const dateTotals = {};
    receiptsThisMonth.forEach(receipt => {
      const day = dayjs(receipt.purchased_at).date();
      if (!dateTotals[day]) {
        dateTotals[day] = { income: 0, expense: 0, transfer: 0 };
      }

      // 거래 타입 구분 (merchant 이름으로 임시 구분)
      const merchant = receipt.merchant || '';
      const isIncome = merchant.includes('수입');
      const isTransfer = merchant.includes('이체');

      if (isIncome) {
        dateTotals[day].income += receipt.total;
      } else if (isTransfer) {
        dateTotals[day].transfer += receipt.total;
      } else {
        dateTotals[day].expense += receipt.total;
      }
    });

    // Build calendar HTML
    let calendarHTML = '<div class="w-full">';

    // Day headers
    calendarHTML += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 4px;">';
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(day => {
      calendarHTML += `<div style="text-align: center; font-family: Montserrat; font-weight: 500; font-size: 10px;">${day}</div>`;
    });
    calendarHTML += '</div>';

    // Calendar grid
    calendarHTML += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">';

    // Empty cells before first day
    for (let i = 0; i < startingDayOfWeek; i++) {
      calendarHTML += '<div style="aspect-ratio: 1;"></div>';
    }

    // Date cells
    for (let day = 1; day <= daysInMonth; day++) {
      const hasTransactions = dateTotals[day];
      let amountHTML = '';

      if (hasTransactions) {
        if (hasTransactions.income > 0) {
          amountHTML += `<div style="font-size: 8px; color: #4CAF50; font-weight: 500;">+${hasTransactions.income.toLocaleString()}</div>`;
        }
        if (hasTransactions.expense > 0) {
          amountHTML += `<div style="font-size: 8px; color: #AF4C4E; font-weight: 500;">-${hasTransactions.expense.toLocaleString()}</div>`;
        }
        if (hasTransactions.transfer > 0) {
          amountHTML += `<div style="font-size: 8px; color: #878787; font-weight: 500;">${hasTransactions.transfer.toLocaleString()}</div>`;
        }
      }

      const bgColor = hasTransactions ? '#F5F5F5' : 'transparent';
      calendarHTML += `
        <div style="aspect-ratio: 1; border: 1px solid #E0E0E0; border-radius: 6px; padding: 2px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; background-color: ${bgColor};">
          <div style="font-family: Montserrat; font-size: 11px; font-weight: 500;">${day}</div>
          ${amountHTML}
        </div>
      `;
    }

    calendarHTML += '</div></div>';

    calendarContainer.innerHTML = calendarHTML;
  }

  function groupReceiptsByDate(receipts) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    const groups = {};

    receipts.forEach(receipt => {
      const receiptDate = new Date(receipt.purchased_at);
      receiptDate.setHours(0, 0, 0, 0);
      const timestamp = receiptDate.getTime();

      if (!groups[timestamp]) {
        groups[timestamp] = {
          date: receiptDate,
          receipts: []
        };
      }
      groups[timestamp].receipts.push(receipt);
    });

    // Sort by date (newest first)
    return Object.values(groups).sort((a, b) => b.date.getTime() - a.date.getTime());
  }

  function getDateLabel(date) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    const dateTime = date.getTime();
    const todayTime = today.getTime();
    const yesterdayTime = yesterday.getTime();

    if (dateTime === todayTime) {
      return 'Today';
    } else if (dateTime === yesterdayTime) {
      return 'Yesterday';
    } else {
      const day = date.getDate();
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const month = months[date.getMonth()];
      return `${day} ${month}`;
    }
  }

  function renderGroupedTransactions(groups) {
    if (groups.length === 0) {
      transactionsContainer.innerHTML = '<p class="text-center text-gray font-roboto text-[14px]">거래내역이 없습니다</p>';
      return;
    }

    const html = groups.map(group => {
      const dateLabel = getDateLabel(group.date);
      const cardsHtml = group.receipts.map(receipt => renderTransactionCard(receipt)).join('');

      return `
        <div class="mb-5">
          <h3 class="font-montserrat font-medium text-[20px] text-text text-center mb-4">${dateLabel}</h3>
          <div class="space-y-4">
            ${cardsHtml}
          </div>
        </div>
      `;
    }).join('');

    transactionsContainer.innerHTML = html;
  }

  function renderTransactionCard(receipt) {
    const amount = receipt.total.toLocaleString();
    // 타입별 색상: 지출(expense), 수입(income), 이체(transfer)
    const type = receipt.type || 'expense'; // 기본값 지출
    let amountColor, amountSign;

    if (type === 'expense') {
      amountColor = '#AF4C4E';
      amountSign = '-';
    } else if (type === 'income') {
      amountColor = '#4CAF50';
      amountSign = '+';
    } else { // transfer
      amountColor = '#878787';
      amountSign = '';
    }

    return `
      <div class="relative" style="overflow: hidden;">
        <div class="transaction-item bg-white rounded-[20px] p-[20px] cursor-pointer transition-transform duration-200"
             style="position: relative; z-index: 2;"
             data-receipt-id="${receipt.id}"
             onclick="openReceiptModal(${receipt.id})">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-[12px]">
              <div class="w-[56px] h-[52px] bg-[#F2F2F2] rounded-[8px] flex items-center justify-center flex-shrink-0">
                <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
                  <path d="M3 9L5 3H19L21 9M3 9V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V9M3 9H21M9 13C9 14.6569 10.3431 16 12 16C13.6569 16 15 14.6569 15 13" stroke="#828282" stroke-width="2"/>
                </svg>
              </div>
              <div class="flex flex-col justify-center">
                <h4 class="font-montserrat font-semibold text-[20px] leading-tight text-text mb-[2px]">${receipt.merchant}</h4>
                <p class="font-montserrat text-[15px] leading-tight text-[#727272]">${type === 'expense' ? (receipt.category || '') : ''}</p>
              </div>
            </div>
            <div class="flex items-center">
              <p class="font-montserrat font-semibold text-[20px]" style="color: ${amountColor}">
                ${amountSign}${amount}원
              </p>
            </div>
          </div>
        </div>

        <!-- 삭제 버튼 (스와이프 시 나타남) -->
        <div class="delete-button" style="position: absolute; top: 0; right: -98px; width: 98px; height: 100%; display: flex; align-items: center; justify-content: center; z-index: 1; transition: right 0.2s;"
             onclick="deleteReceipt(${receipt.id}); event.stopPropagation();">
          <svg width="98" height="86" viewBox="0 0 98 86" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="94" height="82" rx="18" stroke="#AF4C4E" stroke-width="4"/>
            <path d="M33.3739 33.04H35.9899V35.056C35.9899 36.48 35.7659 37.824 35.3179 39.088C34.8699 40.336 34.1899 41.432 33.2779 42.376C32.3659 43.32 31.1899 44.024 29.7499 44.488L28.1659 41.944C29.3979 41.544 30.3899 40.992 31.1419 40.288C31.9099 39.568 32.4699 38.76 32.8219 37.864C33.1899 36.952 33.3739 36.016 33.3739 35.056V33.04ZM34.0459 33.04H36.6139V35.368C36.6139 36.024 36.7099 36.672 36.9019 37.312C37.0939 37.952 37.3899 38.56 37.7899 39.136C38.1899 39.696 38.7019 40.2 39.3259 40.648C39.9659 41.08 40.7179 41.432 41.5819 41.704L40.0219 44.224C38.6619 43.776 37.5339 43.112 36.6379 42.232C35.7579 41.352 35.1019 40.32 34.6699 39.136C34.2539 37.952 34.0459 36.696 34.0459 35.368V33.04ZM42.6859 31.912H45.8779V45.328H42.6859V31.912ZM45.0139 37.312H48.8299V39.928H45.0139V37.312ZM31.0459 46.264H45.8779V54.136H42.6859V48.808H31.0459V46.264ZM66.516 31.888H69.564V54.112H66.516V31.888ZM59.196 39.496H62.892V42.088H59.196V39.496ZM62.028 32.248H65.004V53.104H62.028V32.248ZM54.42 35.512H56.82V37.792C56.82 39.04 56.724 40.272 56.532 41.488C56.356 42.704 56.076 43.856 55.692 44.944C55.308 46.016 54.804 46.984 54.18 47.848C53.556 48.712 52.804 49.424 51.924 49.984L50.028 47.632C51.116 46.944 51.98 46.08 52.62 45.04C53.26 43.984 53.716 42.832 53.988 41.584C54.276 40.32 54.42 39.056 54.42 37.792V35.512ZM55.14 35.512H57.516V37.792C57.516 39.024 57.652 40.24 57.924 41.44C58.196 42.64 58.644 43.736 59.268 44.728C59.892 45.704 60.74 46.504 61.812 47.128L59.964 49.432C58.78 48.728 57.836 47.776 57.132 46.576C56.428 45.376 55.916 44.024 55.596 42.52C55.292 41 55.14 39.424 55.14 37.792V35.512ZM50.844 34.12H60.756V36.688H50.844V34.12Z" fill="#AF4C4E"/>
          </svg>
        </div>
      </div>
    `;
  }

  // Load receipts from API
  async function loadReceipts() {
    try {
      console.log('Fetching receipts from /receipts...');
      const response = await fetch('/receipts');
      console.log('Response status:', response.status);
      const result = await response.json();
      console.log('Result:', result);

      if (result.status === 'ok' && result.data && result.data.length > 0) {
        receiptsData = result.data;
        console.log('Receipts data loaded:', receiptsData.length, 'receipts');
        // Group receipts by date for list view
        const groupedReceipts = groupReceiptsByDate(result.data);
        renderGroupedTransactions(groupedReceipts);
      } else {
        // No data or error status
        console.log('No data or error status:', result);
        receiptsData = [];
        transactionsContainer.innerHTML = '<p class="text-center text-gray font-roboto text-[14px]">거래내역이 없습니다</p>';
      }
    } catch (error) {
      console.error('Error loading receipts:', error);
      receiptsData = [];
      transactionsContainer.innerHTML = '<p class="text-center text-gray font-roboto text-[14px]">거래내역이 없습니다</p>';
    }
  }

  // Load receipts on page load
  await loadReceipts();

  // ===== 스와이프 삭제 기능 (터치 + 마우스) =====
  let swipeStartX = 0;
  let swipeCurrentX = 0;
  let swipeItem = null;
  let isDragging = false;
  window.wasSwiped = false; // 스와이프 여부 플래그 (전역)

  document.addEventListener('touchstart', handleSwipeStart, { passive: true });
  document.addEventListener('mousedown', handleSwipeStart);
  document.addEventListener('touchmove', handleSwipeMove, { passive: false });
  document.addEventListener('mousemove', handleSwipeMove);
  document.addEventListener('touchend', handleSwipeEnd);
  document.addEventListener('mouseup', handleSwipeEnd);

  function handleSwipeStart(e) {
    const target = e.target.closest('.transaction-item');
    if (!target) return;

    swipeItem = target.parentElement;
    swipeStartX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
    swipeCurrentX = swipeStartX;
    isDragging = true;
    window.wasSwiped = false;
    swipeItem.style.transition = 'none';
  }

  function handleSwipeMove(e) {
    if (!isDragging || !swipeItem) return;

    swipeCurrentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
    const diffX = swipeCurrentX - swipeStartX;

    // 스와이프 거리가 10px 이상이면 스와이프로 간주
    if (Math.abs(diffX) > 10) {
      window.wasSwiped = true;
    }

    // 왼쪽으로만 스와이프 가능
    if (diffX < 0) {
      e.preventDefault();
      const translateX = Math.max(diffX, -98); // 최대 98px
      swipeItem.querySelector('.transaction-item').style.transform = `translateX(${translateX}px)`;
      swipeItem.querySelector('.delete-button').style.right = `${-98 - translateX}px`;
    }
  }

  function handleSwipeEnd() {
    if (!isDragging || !swipeItem) return;

    const diffX = swipeCurrentX - swipeStartX;
    swipeItem.style.transition = 'all 0.3s ease';
    swipeItem.querySelector('.transaction-item').style.transition = 'transform 0.3s ease';
    swipeItem.querySelector('.delete-button').style.transition = 'right 0.3s ease';

    // -50px 이상 스와이프하면 삭제 버튼 보이기
    if (diffX < -50) {
      swipeItem.querySelector('.transaction-item').style.transform = 'translateX(-98px)';
      swipeItem.querySelector('.delete-button').style.right = '0px';
    } else {
      swipeItem.querySelector('.transaction-item').style.transform = 'translateX(0)';
      swipeItem.querySelector('.delete-button').style.right = '-98px';
    }

    isDragging = false;
    swipeItem = null;
    swipeStartX = 0;
    swipeCurrentX = 0;

    // 스와이프였으면 잠시 후 플래그 리셋 (클릭 이벤트 전파 방지)
    if (window.wasSwiped) {
      setTimeout(() => {
        window.wasSwiped = false;
      }, 100);
    }
  }

  // ===== 검색 기능 =====
  const searchIcon = document.querySelector('a[href="/search"]');
  if (searchIcon) {
    searchIcon.onclick = function(e) {
      e.preventDefault();
      const searchTerm = prompt('검색어를 입력하세요:');
      if (searchTerm && searchTerm.trim()) {
        filterTransactions(searchTerm.trim());
      }
    };
  }

  function filterTransactions(searchTerm) {
    const filtered = receiptsData.filter(receipt => {
      return receipt.merchant.toLowerCase().includes(searchTerm.toLowerCase()) ||
             (receipt.category && receipt.category.toLowerCase().includes(searchTerm.toLowerCase()));
    });

    if (filtered.length > 0) {
      const groupedReceipts = groupReceiptsByDate(filtered);
      renderGroupedTransactions(groupedReceipts);
    } else {
      transactionsContainer.innerHTML = '<p class="text-center text-gray font-roboto text-[14px]">검색 결과가 없습니다</p>';
    }
  }
});

// ===== 모달 함수들 (전역) =====
let currentReceiptId = null;
let currentReceiptType = 'expense'; // 현재 선택된 타입
let currentReceiptCategory = null; // 현재 선택된 카테고리

function selectType(type) {
  currentReceiptType = type;

  // 모든 버튼 초기화
  document.querySelectorAll('.type-btn').forEach(btn => {
    btn.style.borderColor = '#878787';
    btn.style.backgroundColor = 'white';
    btn.style.color = '#111111';
  });

  // 선택된 버튼 스타일 변경
  const selectedBtn = document.getElementById('type' + type.charAt(0).toUpperCase() + type.slice(1));
  if (type === 'expense') {
    selectedBtn.style.borderColor = '#FF6B6B';
    selectedBtn.style.backgroundColor = '#FFE5E5';
    selectedBtn.style.color = '#FF6B6B';
  } else if (type === 'income') {
    selectedBtn.style.borderColor = '#4CAF50';
    selectedBtn.style.backgroundColor = '#E8F5E9';
    selectedBtn.style.color = '#4CAF50';
  } else if (type === 'transfer') {
    selectedBtn.style.borderColor = '#2196F3';
    selectedBtn.style.backgroundColor = '#E3F2FD';
    selectedBtn.style.color = '#2196F3';
  }

  // UI 업데이트
  const categorySection = document.getElementById('categorySection');
  const itemsHeader = document.getElementById('itemsHeader');
  const modalItems = document.getElementById('modalItems');
  const itemsDivider = document.getElementById('itemsDivider');
  const totalLabel = document.getElementById('totalLabel');

  if (type === 'expense') {
    // 지출: 카테고리 및 상품 목록 표시
    if (categorySection) categorySection.style.display = 'block';
    if (itemsHeader) itemsHeader.style.display = 'flex';
    if (itemsDivider) itemsDivider.style.display = 'block';
    if (modalItems) modalItems.style.display = 'block';
    if (totalLabel) totalLabel.textContent = '합계';
  } else {
    // 수입/이체: 카테고리 및 상품 목록 숨김
    if (categorySection) categorySection.style.display = 'none';
    if (itemsHeader) itemsHeader.style.display = 'none';
    if (itemsDivider) itemsDivider.style.display = 'none';
    if (modalItems) modalItems.style.display = 'none';
    if (totalLabel) totalLabel.textContent = '금액';
  }
}

// 카테고리 select 이벤트 리스너
document.addEventListener('DOMContentLoaded', function() {
  const categorySelect = document.getElementById('categorySelect');
  if (categorySelect) {
    categorySelect.addEventListener('change', function() {
      currentReceiptCategory = this.value;
    });
  }
});

async function openReceiptModal(receiptId) {
  // 스와이프 중이었으면 모달 열지 않음
  if (window.wasSwiped) {
    window.wasSwiped = false;
    return;
  }

  currentReceiptId = receiptId;

  // API에서 상세 정보 가져오기 (상품 정보 포함)
  try {
    const response = await fetch(`/api/receipts/${receiptId}`);
    const result = await response.json();

    if (result.status !== 'ok' || !result.data) {
      console.error('Failed to load receipt detail');
      return;
    }

    const receipt = result.data;

    // 모달 내용 채우기
    document.getElementById('modalMerchant').textContent = receipt.merchant || '상호명 없음';
    document.getElementById('modalAddress').textContent = receipt.address || '주소 없음';
    document.getElementById('modalDate').textContent = dayjs(receipt.purchased_at).format('YYYY년 MM월 DD일');

    // 타입 버튼 선택
    currentReceiptType = receipt.type || 'expense';
    selectType(currentReceiptType);

    document.getElementById('modalTotal').textContent = receipt.total.toLocaleString() + '원';

    // 타입에 따라 UI 변경
    const categorySection = document.getElementById('categorySection');
    const itemsHeader = document.getElementById('itemsHeader');
    const modalItems = document.getElementById('modalItems');
    const itemsDivider = document.getElementById('itemsDivider');
    const totalLabel = document.getElementById('totalLabel');

    if (currentReceiptType === 'expense') {
      // 지출: 카테고리 및 상품 목록 표시
      categorySection.style.display = 'block';
      itemsHeader.style.display = 'flex';
      itemsDivider.style.display = 'block';
      totalLabel.textContent = '합계';

      // 카테고리 초기화
      currentReceiptCategory = receipt.category || '';
      const categorySelect = document.getElementById('categorySelect');
      if (categorySelect) {
        categorySelect.value = currentReceiptCategory;
      }

      // 상품 목록 표시
      if (receipt.items && receipt.items.length > 0) {
        const itemsHtml = receipt.items.map(item => `
          <div class="flex justify-between text-[14px] font-satoshi font-bold text-[#878787] mb-2">
            <span class="flex-1">${item.name}</span>
            <span class="w-[26px] text-center">${item.qty}</span>
            <span class="w-[60px] text-right">${item.price.toLocaleString()}</span>
            <span class="w-[60px] text-right">${item.subtotal.toLocaleString()}</span>
          </div>
        `).join('');
        modalItems.innerHTML = itemsHtml;
      } else {
        modalItems.innerHTML = `
          <div class="flex justify-between text-[14px] font-satoshi font-bold text-[#878787] mb-2">
            <span class="flex-1">상품 정보 없음</span>
            <span class="w-[26px] text-center">-</span>
            <span class="w-[60px] text-right">-</span>
            <span class="w-[60px] text-right">-</span>
          </div>
        `;
      }
      modalItems.style.display = 'block';
    } else {
      // 수입/이체: 카테고리 및 상품 목록 숨김
      categorySection.style.display = 'none';
      itemsHeader.style.display = 'none';
      itemsDivider.style.display = 'none';
      modalItems.style.display = 'none';
      totalLabel.textContent = '금액';
    }

    // 모달 표시
    const modal = document.getElementById('receiptModal');
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
  } catch (error) {
    console.error('Error loading receipt detail:', error);
  }
}

function closeReceiptModal(event) {
  if (!event || event.target.id === 'receiptModal') {
    const modal = document.getElementById('receiptModal');
    modal.classList.add('hidden');
    modal.style.display = 'none';
    currentReceiptId = null;
  }
}

function editReceipt() {
  if (!currentReceiptId) return;
  alert('수정 기능은 백엔드 API 연동 후 구현됩니다.');
  closeReceiptModal();
}

async function deleteReceipt(receiptId) {
  if (!confirm('이 거래내역을 삭제하시겠습니까?')) return;

  try {
    const response = await fetch(`/receipts/${receiptId}/delete`, {
      method: 'POST'
    });

    if (response.ok) {
      // 성공 시 목록에서 제거
      receiptsData = receiptsData.filter(r => r.id !== receiptId);
      const groupedReceipts = groupReceiptsByDate(receiptsData);
      renderGroupedTransactions(groupedReceipts);
      if (window.ToastHelper) {
        window.ToastHelper.success('거래내역이 삭제되었습니다.');
      }
    } else {
      throw new Error('삭제 실패');
    }
  } catch (error) {
    console.error('Error deleting receipt:', error);
    alert('삭제에 실패했습니다. 백엔드 API를 확인해주세요.');
  }
}
</script>
{% endblock %}
