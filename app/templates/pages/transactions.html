{% extends "base.html" %}

{% block content %}
<!-- Navbar -->
{% set variant = 'default' %}
{% include 'components/navbar.html' %}

<div class="max-w-md mx-auto px-5 pb-[120px] pt-[120px]">
  <!-- Header with Year Selector -->
  <div class="flex items-center justify-center mb-6 relative">
    <div class="absolute left-0 flex items-center gap-[3px]">
      <select id="yearSelect" class="font-montserrat font-semibold text-[15px] text-text bg-transparent border-none outline-none appearance-none cursor-pointer">
        <option>2025</option>
        <option>2024</option>
        <option>2023</option>
      </select>
      <svg id="yearArrow" class="cursor-pointer" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M11.4899 4.10156H2.51017C2.24083 4.10156 2.09044 4.38594 2.25724 4.58008L6.74708 9.78633C6.8756 9.93535 7.12306 9.93535 7.25294 9.78633L11.7428 4.58008C11.9096 4.38594 11.7592 4.10156 11.4899 4.10156Z" fill="black"/>
      </svg>
    </div>
    <h1 class="font-montserrat font-bold text-[25px] text-text">통계</h1>
  </div>

  <!-- Chart Card -->
  <div class="bg-white rounded-[20px] shadow-[0px_8px_33px_-9px_rgba(0,0,0,0.15)] p-6 mb-8">
    <!-- Chart with grid lines -->
    <div class="relative h-[183px]">
      <!-- Y-axis labels -->
      <div class="absolute left-0 top-0 bottom-0 w-[30px] flex flex-col justify-between text-right pr-3">
        <span class="font-montserrat font-semibold text-[10px] text-gray-light">￦40K</span>
        <span class="font-montserrat font-semibold text-[10px] text-gray-light">￦30K</span>
        <span class="font-montserrat font-semibold text-[10px] text-text">￦20K</span>
        <span class="font-montserrat font-semibold text-[10px] text-gray-light">￦10K</span>
        <span class="font-montserrat font-semibold text-[10px] text-gray-light">￦5K</span>
        <span class="font-montserrat font-semibold text-[10px] text-gray-light">￦1K</span>
        <span class="font-montserrat font-semibold text-[10px] text-gray-light">￦0.5K</span>
      </div>

      <!-- Chart area -->
      <div class="absolute left-[50px] right-0 top-0 bottom-0">
        <!-- Grid lines -->
        <div class="absolute inset-0 flex flex-col justify-between">
          <div class="border-t border-dashed border-[#F4F4F4]"></div>
          <div class="border-t border-dashed border-[#F4F4F4]"></div>
          <div class="border-t border-dashed border-[#F4F4F4]"></div>
          <div class="border-t border-dashed border-[#F4F4F4]"></div>
          <div class="border-t border-dashed border-[#F4F4F4]"></div>
          <div class="border-t border-dashed border-[#F4F4F4]"></div>
          <div class="border-t border-dashed border-[#F4F4F4]"></div>
        </div>

        <!-- Chart line (simplified) -->
        <svg class="absolute inset-0 w-full h-full" viewBox="0 0 272 152" preserveAspectRatio="none">
          <!-- Gradient fill -->
          <defs>
            <linearGradient id="chartGradient" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" style="stop-color:rgba(180, 222, 0, 0.47);stop-opacity:1" />
              <stop offset="100%" style="stop-color:rgba(196, 196, 196, 0);stop-opacity:0" />
            </linearGradient>
          </defs>
          <path d="M0 100 L68 80 L136 60 L204 40 L272 30 L272 152 L0 152 Z" fill="url(#chartGradient)"/>
          <path d="M0 100 L68 80 L136 60 L204 40 L272 30" stroke="#B4DE00" stroke-width="2" fill="none"/>
          <circle cx="272" cy="30" r="4" fill="white" stroke="#B4DE00" stroke-width="2"/>
        </svg>

        <!-- X-axis labels -->
        <div class="absolute bottom-[-20px] left-0 right-0 flex justify-between px-2">
          <span class="font-montserrat font-semibold text-[10px] text-gray-light">Jan</span>
          <span class="font-montserrat font-semibold text-[10px] text-gray-light">Feb</span>
          <span class="font-montserrat font-semibold text-[10px] text-gray-light">Mar</span>
          <span class="font-montserrat font-semibold text-[10px] text-text">Apr</span>
          <span class="font-montserrat font-semibold text-[10px] text-gray-light">May</span>
        </div>

        <!-- Tooltip -->
        <div class="absolute top-[20px] right-[10px] bg-white px-3 py-1 rounded shadow-sm">
          <span class="font-montserrat font-semibold text-[15px] text-text">￦ 20,000</span>
        </div>
      </div>
    </div>
  </div>

  <!-- History Header with View Toggle -->
  <div class="relative mb-5 h-[35px]">
    <!-- Search Icon: left: 44px - 20px(padding) = 24px -->
    <div class="absolute left-[24px] top-0 w-[35px] h-[35px] flex items-center justify-center">
      <svg width="35" height="35" viewBox="0 0 35 35" fill="none">
        <g clip-path="url(#clip0_207_1318)">
          <path d="M15.3125 26.25C21.3531 26.25 26.25 21.3531 26.25 15.3125C26.25 9.27189 21.3531 4.375 15.3125 4.375C9.27189 4.375 4.375 9.27189 4.375 15.3125C4.375 21.3531 9.27189 26.25 15.3125 26.25Z" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M23.0467 23.0466L30.625 30.625" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        <defs>
          <clipPath id="clip0_207_1318">
            <rect width="35" height="35" fill="white"/>
          </clipPath>
        </defs>
      </svg>
    </div>

    <!-- History Title: left: 167px - 20px(padding) = 147px -->
    <h2 class="absolute left-[147px] top-[2.5px] w-[94px] h-[30px] font-montserrat font-bold text-[25px] leading-[30px] text-text flex items-center justify-center">History</h2>

    <!-- Month/List Toggle: left: 321px - 20px(padding) = 301px -->
    <div class="absolute left-[301px] top-[3px] w-[71px] h-[29px] flex relative">
      <svg width="71" height="29" viewBox="0 0 71 29" fill="none" xmlns="http://www.w3.org/2000/svg" class="absolute inset-0">
        <rect width="71" height="29" rx="10" fill="#F0F0F0"/>
      </svg>
      <button class="relative w-[30px] h-[25px] m-[2px] rounded-[10px] flex items-center justify-center z-10">
        <svg width="23" height="23" viewBox="0 0 23 23" fill="none">
          <g clip-path="url(#clip_calendar)">
            <path opacity="0.2" d="M3.59375 10.9062H19.4062V7.3125C19.4062 7.12188 19.3305 6.93906 19.1957 6.80427C19.0609 6.66948 18.8781 6.59375 18.6875 6.59375H4.3125C4.12188 6.59375 3.93906 6.66948 3.80427 6.80427C3.66948 6.93906 3.59375 7.12188 3.59375 7.3125V10.9062Z" fill="black"/>
            <path d="M18.6875 6.59375H4.3125C3.91555 6.59375 3.59375 6.91555 3.59375 7.3125V21.6875C3.59375 22.0845 3.91555 22.4062 4.3125 22.4062H18.6875C19.0845 22.4062 19.4062 22.0845 19.4062 21.6875V7.3125C19.4062 6.91555 19.0845 6.59375 18.6875 6.59375Z" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M15.8125 5.15625V8.03125M7.1875 5.15625V8.03125M3.59375 10.9062H19.4062" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M11.5 15.9375C12.0954 15.9375 12.5781 15.4548 12.5781 14.8594C12.5781 14.2639 12.0954 13.7812 11.5 13.7812C10.9046 13.7812 10.4219 14.2639 10.4219 14.8594C10.4219 15.4548 10.9046 15.9375 11.5 15.9375Z" fill="black"/>
            <path d="M15.4531 15.9375C16.0486 15.9375 16.5312 15.4548 16.5312 14.8594C16.5312 14.2639 16.0486 13.7812 15.4531 13.7812C14.8577 13.7812 14.375 14.2639 14.375 14.8594C14.375 15.4548 14.8577 15.9375 15.4531 15.9375Z" fill="black"/>
            <path d="M7.54687 19.5312C8.14228 19.5312 8.625 19.0486 8.625 18.4531C8.625 17.8577 8.14228 17.375 7.54687 17.375C6.95146 17.375 6.46875 17.8577 6.46875 18.4531C6.46875 19.0486 6.95146 19.5312 7.54687 19.5312Z" fill="black"/>
            <path d="M11.5 19.5312C12.0954 19.5312 12.5781 19.0486 12.5781 18.4531C12.5781 17.8577 12.0954 17.375 11.5 17.375C10.9046 17.375 10.4219 17.8577 10.4219 18.4531C10.4219 19.0486 10.9046 19.5312 11.5 19.5312Z" fill="black"/>
            <path d="M15.4531 19.5312C16.0486 19.5312 16.5312 19.0486 16.5312 18.4531C16.5312 17.8577 16.0486 17.375 15.4531 17.375C14.8577 17.375 14.375 17.8577 14.375 18.4531C14.375 19.0486 14.8577 19.5312 15.4531 19.5312Z" fill="black"/>
          </g>
          <defs>
            <clipPath id="clip_calendar">
              <rect width="23" height="23" fill="white"/>
            </clipPath>
          </defs>
        </svg>
      </button>
      <button class="relative w-[30px] h-[25px] m-[2px] rounded-[10px] bg-black bg-opacity-[0.39] flex items-center justify-center z-10">
        <svg width="23" height="23" viewBox="0 0 23 23" fill="none">
          <g clip-path="url(#clip_list)">
            <path opacity="0.2" d="M19.4062 8.75H7.9062V20.25H19.4062V8.75Z" fill="white"/>
            <path d="M7.9062 8.75H19.4062" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7.9071 14.5H19.4062" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7.9071 20.25H19.4062" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M3.9531 9.82812C4.5486 9.82812 5.0312 9.34543 5.0312 8.75C5.0312 8.15457 4.5486 7.67188 3.9531 7.67188C3.3577 7.67188 2.875 8.15457 2.875 8.75C2.875 9.34543 3.3577 9.82812 3.9531 9.82812Z" fill="white"/>
            <path d="M3.9531 15.5781C4.5486 15.5781 5.0312 15.0954 5.0312 14.5C5.0312 13.9046 4.5486 13.4219 3.9531 13.4219C3.3577 13.4219 2.875 13.9046 2.875 14.5C2.875 15.0954 3.3577 15.5781 3.9531 15.5781Z" fill="white"/>
            <path d="M3.9531 21.3281C4.5486 21.3281 5.0312 20.8454 5.0312 20.25C5.0312 19.6546 4.5486 19.1719 3.9531 19.1719C3.3577 19.1719 2.875 19.6546 2.875 20.25C2.875 20.8454 3.3577 21.3281 3.9531 21.3281Z" fill="white"/>
          </g>
          <defs>
            <clipPath id="clip_list">
              <rect width="23" height="23" fill="white"/>
            </clipPath>
          </defs>
        </svg>
      </button>
    </div>
  </div>

  <!-- Transaction Sections -->
  <div id="transactions-container">
    <!-- Transaction sections will be dynamically loaded here -->
  </div>
</div>

<!-- Footer -->
{% set active = 'chart' %}
{% include 'components/footer.html' %}

<script>
document.addEventListener('DOMContentLoaded', async function() {
  // Year selector arrow click handler
  const yearArrow = document.getElementById('yearArrow');
  const yearSelect = document.getElementById('yearSelect');
  if (yearArrow && yearSelect) {
    yearArrow.addEventListener('click', function() {
      yearSelect.focus();
      yearSelect.click();
    });
  }

  const transactionsContainer = document.getElementById('transactions-container');

  // Load receipts from API
  async function loadReceipts() {
    try {
      const response = await fetch('/receipts');
      const result = await response.json();

      if (result.status === 'ok' && result.data) {
        // Group receipts by date
        const groupedReceipts = groupReceiptsByDate(result.data);
        renderGroupedTransactions(groupedReceipts);
      }
    } catch (error) {
      console.error('Error loading receipts:', error);
    }
  }

  function groupReceiptsByDate(receipts) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    const groups = {};

    receipts.forEach(receipt => {
      const receiptDate = new Date(receipt.purchased_at);
      receiptDate.setHours(0, 0, 0, 0);
      const timestamp = receiptDate.getTime();

      if (!groups[timestamp]) {
        groups[timestamp] = {
          date: receiptDate,
          receipts: []
        };
      }
      groups[timestamp].receipts.push(receipt);
    });

    // Sort by date (newest first)
    return Object.values(groups).sort((a, b) => b.date.getTime() - a.date.getTime());
  }

  function getDateLabel(date) {
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);

    const dateTime = date.getTime();
    const todayTime = today.getTime();
    const yesterdayTime = yesterday.getTime();

    if (dateTime === todayTime) {
      return 'Today';
    } else if (dateTime === yesterdayTime) {
      return 'Yesterday';
    } else {
      const day = date.getDate();
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const month = months[date.getMonth()];
      return `${day} ${month}`;
    }
  }

  function renderGroupedTransactions(groups) {
    if (groups.length === 0) {
      transactionsContainer.innerHTML = '<p class="text-center text-gray font-roboto text-[14px]">거래내역이 없습니다</p>';
      return;
    }

    const html = groups.map(group => {
      const dateLabel = getDateLabel(group.date);
      const cardsHtml = group.receipts.map(receipt => renderTransactionCard(receipt)).join('');

      return `
        <div class="mb-5">
          <h3 class="font-montserrat font-medium text-[20px] text-text text-center mb-4">${dateLabel}</h3>
          <div class="space-y-4">
            ${cardsHtml}
          </div>
        </div>
      `;
    }).join('');

    transactionsContainer.innerHTML = html;
  }

  function renderTransactionCard(receipt) {
    const amount = receipt.total.toLocaleString();
    const isExpense = receipt.total > 0;

    return `
      <div class="bg-white rounded-[20px] shadow-[0px_8px_33px_-9px_rgba(0,0,0,0.15)] p-[20px] cursor-pointer hover:shadow-lg transition-shadow"
           onclick="window.location.href='/receipt/${receipt.id}'">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-[12px]">
            <div class="w-[56px] h-[52px] bg-[#F2F2F2] rounded-[8px] flex items-center justify-center flex-shrink-0">
              <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
                <path d="M3 9L5 3H19L21 9M3 9V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V9M3 9H21M9 13C9 14.6569 10.3431 16 12 16C13.6569 16 15 14.6569 15 13" stroke="#828282" stroke-width="2"/>
              </svg>
            </div>
            <div class="flex flex-col justify-center">
              <h4 class="font-montserrat font-semibold text-[20px] leading-tight text-text mb-[2px]">${receipt.merchant}</h4>
              <p class="font-montserrat text-[15px] leading-tight text-[#727272]">${receipt.status === 'CONFIRMED' ? 'Food' : 'Pending'}</p>
            </div>
          </div>
          <div class="flex items-center">
            <p class="font-montserrat font-semibold text-[20px] ${isExpense ? 'text-[#FF6B6B]' : 'text-[#4CAF50]'}">
              ${isExpense ? '-' : '+'}${amount}원
            </p>
          </div>
        </div>
      </div>
    `;
  }

  // Load receipts on page load
  await loadReceipts();
});
</script>

{% endblock %}
