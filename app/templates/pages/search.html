{% set navbar_variant = 'back' %}
{% set back_url = '/transactions' %}
{% set footer_active = 'chart' %}
{% extends "base.html" %}

{% block title %}검색 - Smart Ledger{% endblock %}

{% block content %}
<div style="padding-top: 107px; padding-bottom: 107px;">

  <!-- Search Input Container: padding-left: 84px, padding-right: 84px -->
  <div class="relative px-[84px] mt-[38px]">
    <input
      type="text"
      id="searchInput"
      placeholder="상호 및 메모 내용을 입력하세요"
      class="w-full border-b border-[#ACB1C6] pb-[10px] font-inter text-[14px] text-black placeholder-[#ACB1C6] outline-none"
      autofocus
    />

    <!-- Search Icon: absolute right -->
    <div class="absolute right-[84px] top-0 cursor-pointer">
      <svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2.95366 17.8445L8.05838 12.7435L5.4189 10.104L0.314179 15.2087C-0.104727 15.6276 -0.104727 16.3172 0.314179 16.7361L1.42261 17.8445C1.84522 18.2634 2.53846 18.2634 2.95366 17.8445Z" fill="#ACB1C6"/>
        <path d="M6.55696 10.2192L7.93972 11.6019L9.51525 10.0264C11.6617 11.5167 14.6348 11.3091 16.5477 9.39619C18.6941 7.24976 18.6941 3.76135 16.5477 1.61121C14.4012 -0.538923 10.9128 -0.535216 8.7627 1.61121C6.84982 3.52409 6.64222 6.49721 8.13249 8.64364L6.55696 10.2192ZM9.84518 2.67887C11.4022 1.12187 13.9267 1.12187 15.48 2.67887C17.037 4.23586 17.037 6.76042 15.48 8.31371C13.923 9.8707 11.3985 9.8707 9.84518 8.31371C8.28819 6.76042 8.28819 4.23586 9.84518 2.67887Z" fill="#ACB1C6"/>
      </svg>
    </div>
  </div>

  <!-- Search Results: padding: 0 37px -->
  <div id="searchResults" class="px-[37px] mt-[30px]">
    <p class="text-center text-[#ACB1C6] font-inter text-[14px] mt-10">검색 결과가 없습니다</p>
  </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
  const searchInput = document.getElementById('searchInput');
  const searchResults = document.getElementById('searchResults');
  let receiptsData = [];

  // Load receipts from API
  async function loadReceipts() {
    try {
      const response = await fetch('/receipts');
      const result = await response.json();

      if (result.status === 'ok' && result.data && result.data.length > 0) {
        receiptsData = result.data;
      }
    } catch (error) {
      console.error('Error loading receipts:', error);
    }
  }

  searchInput.addEventListener('input', function() {
    const query = searchInput.value.toLowerCase().trim();

    if (!query) {
      searchResults.innerHTML = '<p class="text-center text-[#ACB1C6] font-inter text-[14px] mt-10">검색 결과가 없습니다</p>';
      return;
    }

    // Search in receipts
    const filtered = receiptsData.filter(receipt => {
      return receipt.merchant.toLowerCase().includes(query) ||
             (receipt.memo && receipt.memo.toLowerCase().includes(query));
    });

    if (filtered.length === 0) {
      searchResults.innerHTML = '<p class="text-center text-[#ACB1C6] font-inter text-[14px] mt-10">검색 결과가 없습니다</p>';
      return;
    }

    // Render search results
    const resultsHTML = filtered.map(receipt => {
      const amount = receipt.total.toLocaleString();
      const isExpense = receipt.total > 0;

      return `
        <div class="bg-white rounded-[20px] shadow-[0px_8px_33px_-9px_rgba(0,0,0,0.15)] p-[20px] cursor-pointer hover:shadow-lg transition-shadow"
             onclick="window.location.href='/receipt/${receipt.id}'">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-[12px]">
              <div class="w-[56px] h-[52px] bg-[#F2F2F2] rounded-[8px] flex items-center justify-center flex-shrink-0">
                <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
                  <path d="M3 9L5 3H19L21 9M3 9V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V9M3 9H21M9 13C9 14.6569 10.3431 16 12 16C13.6569 16 15 14.6569 15 13" stroke="#828282" stroke-width="2"/>
                </svg>
              </div>
              <div class="flex flex-col justify-center">
                <h4 class="font-montserrat font-semibold text-[20px] leading-tight text-text mb-[2px]">${receipt.merchant}</h4>
                <p class="font-montserrat text-[15px] leading-tight text-[#727272]">${receipt.status === 'CONFIRMED' ? 'Food' : 'Pending'}</p>
              </div>
            </div>
            <div class="flex items-center">
              <p class="font-montserrat font-semibold text-[20px] ${isExpense ? 'text-[#FF6B6B]' : 'text-[#4CAF50]'}">
                ${isExpense ? '-' : '+'}${amount}원
              </p>
            </div>
          </div>
        </div>
      `;
    }).join('');

    searchResults.innerHTML = `<div class="space-y-4">${resultsHTML}</div>`;
  });

  // Load receipts on page load
  await loadReceipts();
});
</script>
{% endblock %}
